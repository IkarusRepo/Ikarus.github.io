\hypertarget{a00248_source}{}\doxysection{autodifffe.\+hh}
\label{a00248_source}\index{autodifffe.hh@{autodifffe.hh}}
\mbox{\hyperlink{a00248}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// SPDX-\/FileCopyrightText: 2021-\/2024 The Ikarus Developers mueller@ibb.uni-\/stuttgart.de}}
\DoxyCodeLine{2 \textcolor{comment}{// SPDX-\/License-\/Identifier: LGPL-\/3.0-\/or-\/later}}
\DoxyCodeLine{3 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <autodiff/forward/dual/dual.hpp>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <autodiff/forward/dual/eigen.hpp>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00257}{ikarus/finiteelements/ferequirements.hh}}>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00023}{ikarus/utils/traits.hh}}>}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{keyword}{namespace }\mbox{\hyperlink{a00328}{Ikarus}} \{}
\DoxyCodeLine{18 }
\DoxyCodeLine{26 \textcolor{keyword}{template} <\textcolor{keyword}{typename} FEImpl, \textcolor{keywordtype}{bool} forceAutoDiff = false>}
\DoxyCodeLine{27 \textcolor{keyword}{class }\mbox{\hyperlink{a01228}{AutoDiffFE}} : \textcolor{keyword}{public} FEImpl}
\DoxyCodeLine{28 \{}
\DoxyCodeLine{29 \textcolor{keyword}{public}:}
\DoxyCodeLine{30   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_ac6509944238101aef666b1614df1d443}{RealFE}}            = FEImpl;                             }
\DoxyCodeLine{31   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_ace1636b5cd13f380d0865682480e81b2}{BasisHandler}}      = \textcolor{keyword}{typename} RealFE::BasisHandler;      }
\DoxyCodeLine{32   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_acb52d8adef8b40aabec280ecd1db60f6}{Base}}              = \textcolor{keyword}{typename} RealFE::Base;              }
\DoxyCodeLine{33   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_a25b17a1ebebcf86b4994f735ae7b5281}{Traits}}            = \textcolor{keyword}{typename} Base::Traits;              }
\DoxyCodeLine{34   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_ae985fb2fdb86d514700c4d57f03e97d5}{LocalView}}         = \textcolor{keyword}{typename} Traits::LocalView;         }
\DoxyCodeLine{35   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_af1d3fa6b651ee728bd39a33c3c3da250}{Element}}           = \textcolor{keyword}{typename} Traits::Element;           }
\DoxyCodeLine{36   \textcolor{keyword}{using }\mbox{\hyperlink{a01228_a4d0caa6dbe1dea19b8a265e7074cc45f}{FERequirementType}} = \textcolor{keyword}{typename} Traits::FERequirementType; }
\DoxyCodeLine{37 }
\DoxyCodeLine{44   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01228_a374cdfcdf85fcaba0114571ee4ef95d0}{calculateMatrix}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01228_a4d0caa6dbe1dea19b8a265e7074cc45f}{FERequirementType}}\& req, \textcolor{keyword}{typename} Traits::template MatrixType<> h)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{45     \textcolor{comment}{// real element implements calculateMatrix by itself, then we simply forward the call}}
\DoxyCodeLine{46     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ RealFE::calculateMatrix(req, h); \} and not forceAutoDiff) \{}
\DoxyCodeLine{47       RealFE::calculateMatrix(req, h);}
\DoxyCodeLine{48     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{49                            this-\/>\textcolor{keyword}{template} calculateVectorImpl<autodiff::dual>(}
\DoxyCodeLine{50                                req, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<autodiff::dual>>(),}
\DoxyCodeLine{51                                std::declval<const Eigen::VectorXdual\&>());}
\DoxyCodeLine{52                          \}) \{}
\DoxyCodeLine{53       \textcolor{comment}{// real element implements calculateVector by itself, therefore we only need first order derivatives}}
\DoxyCodeLine{54       Eigen::VectorXdual dx(this-\/>localView().size());}
\DoxyCodeLine{55       Eigen::VectorXdual g(this-\/>localView().size());}
\DoxyCodeLine{56       dx.setZero();}
\DoxyCodeLine{57       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) -\/> \textcolor{keyword}{auto}\& \{}
\DoxyCodeLine{58         g.setZero();}
\DoxyCodeLine{59         this-\/>\textcolor{keyword}{template} calculateVectorImpl<autodiff::dual>(req, g, x);}
\DoxyCodeLine{60         \textcolor{keywordflow}{return} g;}
\DoxyCodeLine{61       \};}
\DoxyCodeLine{62       jacobian(f, autodiff::wrt(dx), at(dx), g, h);}
\DoxyCodeLine{63     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{64                            this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual2nd>(}
\DoxyCodeLine{65                                req, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<autodiff::dual2nd>>());}
\DoxyCodeLine{66                          \}) \{}
\DoxyCodeLine{67       \textcolor{comment}{// real element implements calculateScalar by itself, therefore we need second order derivatives}}
\DoxyCodeLine{68       Eigen::VectorXdual2nd dx(this-\/>localView().size());}
\DoxyCodeLine{69       Eigen::VectorXd g;}
\DoxyCodeLine{70       autodiff::dual2nd e;}
\DoxyCodeLine{71       dx.setZero();}
\DoxyCodeLine{72       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual2nd>(req, x); \};}
\DoxyCodeLine{73       hessian(f, autodiff::wrt(dx), at(dx), e, g, h);}
\DoxyCodeLine{74     \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{75       \textcolor{keyword}{static\_assert}(Dune::AlwaysFalse<AutoDiffFE>::value,}
\DoxyCodeLine{76                     \textcolor{stringliteral}{"{}Appropriate calculateScalarImpl or calculateVectorImpl functions are not implemented for the "{}}}
\DoxyCodeLine{77                     \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{78   \}}
\DoxyCodeLine{79 }
\DoxyCodeLine{86   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01228_ae2d3a5600747957c5dfb84455c1e1648}{calculateVector}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01228_a4d0caa6dbe1dea19b8a265e7074cc45f}{FERequirementType}}\& req, \textcolor{keyword}{typename} Traits::template VectorType<> g)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{87     \textcolor{comment}{// real element implements calculateVector by itself, then we simply forward the call}}
\DoxyCodeLine{88     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{89                     this-\/>\textcolor{keyword}{template} calculateVectorImpl<double>(}
\DoxyCodeLine{90                         req, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<double>>(),}
\DoxyCodeLine{91                         std::declval<const Eigen::VectorXd\&>());}
\DoxyCodeLine{92                   \} and not forceAutoDiff) \{}
\DoxyCodeLine{93       \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateVectorImpl<double>(req, g);}
\DoxyCodeLine{94     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{95                            this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual>(}
\DoxyCodeLine{96                                req, std::declval<const Eigen::VectorXdual\&>());}
\DoxyCodeLine{97                          \}) \{}
\DoxyCodeLine{98       \textcolor{comment}{// real element implements calculateScalar by itself, therefore we need first order derivatives}}
\DoxyCodeLine{99       Eigen::VectorXdual dx(this-\/>localView().size());}
\DoxyCodeLine{100       dx.setZero();}
\DoxyCodeLine{101       autodiff::dual e;}
\DoxyCodeLine{102       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual>(req, x); \};}
\DoxyCodeLine{103       gradient(f, autodiff::wrt(dx), at(dx), e, g);}
\DoxyCodeLine{104     \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{105       \textcolor{keyword}{static\_assert}(Dune::AlwaysFalse<AutoDiffFE>::value,}
\DoxyCodeLine{106                     \textcolor{stringliteral}{"{}Appropriate calculateScalarImpl function is not implemented for the "{}}}
\DoxyCodeLine{107                     \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{108   \}}
\DoxyCodeLine{109 }
\DoxyCodeLine{117   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01228_a26b7180649b487ae56f5c31e53276cd4}{calculateLocalSystem}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01228_a4d0caa6dbe1dea19b8a265e7074cc45f}{FERequirementType}}\& req, \textcolor{keyword}{typename} Traits::template MatrixType<> h,}
\DoxyCodeLine{118                             \textcolor{keyword}{typename} Traits::template VectorType<> g)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{119     Eigen::VectorXdual2nd dx(this-\/>localView().size());}
\DoxyCodeLine{120     dx.setZero();}
\DoxyCodeLine{121     \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>calculateScalarImpl(req, x); \};}
\DoxyCodeLine{122     hessian(f, autodiff::wrt(dx), at(dx), g, h);}
\DoxyCodeLine{123   \}}
\DoxyCodeLine{124 }
\DoxyCodeLine{131   [[nodiscard]] \textcolor{keywordtype}{double} \mbox{\hyperlink{a01228_a4092c3249a569470e2d9dfbd0af72749}{calculateScalar}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01228_a4d0caa6dbe1dea19b8a265e7074cc45f}{FERequirementType}}\& par)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{132     \textcolor{comment}{// real element implements calculateScalar by itself, then we simply forward the call}}
\DoxyCodeLine{133     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ RealFE::calculateScalar(par); \}) \{}
\DoxyCodeLine{134       \textcolor{keywordflow}{return} RealFE::calculateScalar(par);}
\DoxyCodeLine{135     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ this-\/>calculateScalarImpl(par); \}) \{}
\DoxyCodeLine{136       \textcolor{comment}{// real element only implements the protected calculateScalarImpl by itself, thus we call that one.}}
\DoxyCodeLine{137       \textcolor{keywordflow}{return} this-\/>calculateScalarImpl(par);}
\DoxyCodeLine{138     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{139       \textcolor{keyword}{static\_assert}(Dune::AlwaysFalse<AutoDiffFE>::value,}
\DoxyCodeLine{140                     \textcolor{stringliteral}{"{}Appropriate calculateScalar and calculateScalarImpl functions are not implemented for the "{}}}
\DoxyCodeLine{141                     \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{142     \}}
\DoxyCodeLine{143   \}}
\DoxyCodeLine{144 }
\DoxyCodeLine{150   \textcolor{keyword}{const} \mbox{\hyperlink{a01228_ac6509944238101aef666b1614df1d443}{RealFE}}\& \mbox{\hyperlink{a01228_a8bd5af319955bc66a08c074858df2303}{realFE}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} *\textcolor{keyword}{this}; \}}
\DoxyCodeLine{151 }
\DoxyCodeLine{159   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Args>}
\DoxyCodeLine{160   \textcolor{keyword}{explicit} \mbox{\hyperlink{a01228_a26248faa29dc3165140f3647f94c5d4a}{AutoDiffFE}}(Args\&\&... args)}
\DoxyCodeLine{161       : \mbox{\hyperlink{a01228_ac6509944238101aef666b1614df1d443}{RealFE}}\{std::forward<Args>(args)...\} \{\}}
\DoxyCodeLine{162 \};}
\DoxyCodeLine{163 \} \textcolor{comment}{// namespace Ikarus}}

\end{DoxyCode}
