\hypertarget{a00233_source}{}\doxysection{newtonraphsonwithscalarsubsidiaryfunction.\+hh}
\label{a00233_source}\index{newtonraphsonwithscalarsubsidiaryfunction.hh@{newtonraphsonwithscalarsubsidiaryfunction.hh}}
\mbox{\hyperlink{a00233}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// SPDX-\/FileCopyrightText: 2021-\/2024 The Ikarus Developers mueller@ibb.uni-\/stuttgart.de}}
\DoxyCodeLine{2 \textcolor{comment}{// SPDX-\/License-\/Identifier: LGPL-\/3.0-\/or-\/later}}
\DoxyCodeLine{3 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <iosfwd>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <utility>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00137}{ikarus/controlroutines/pathfollowingfunctions.hh}}>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00236}{ikarus/solver/nonlinearsolver/solverinfos.hh}}>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00050}{ikarus/utils/concepts.hh}}>}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00017}{ikarus/utils/linearalgebrahelper.hh}}>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00005}{ikarus/utils/nonlinearoperator.hh}}>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00248}{ikarus/utils/observer/observer.hh}}>}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00257}{ikarus/utils/observer/observermessages.hh}}>}}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{keyword}{namespace }\mbox{\hyperlink{a00316}{Ikarus}} \{}
\DoxyCodeLine{27 \textcolor{keyword}{struct }\mbox{\hyperlink{a01416}{NewtonRaphsonWithSubsidiaryFunctionSettings}}}
\DoxyCodeLine{28 \{}
\DoxyCodeLine{29   \textcolor{keywordtype}{double} \mbox{\hyperlink{a01416_a7e8e3668e5eca2b115ec77fcaabc8899}{tol}}\{1e-\/8\};}
\DoxyCodeLine{30   \textcolor{keywordtype}{int} \mbox{\hyperlink{a01416_a7ef35a86ec4e9a39bcc54182c5dc17b7}{maxIter}}\{20\};}
\DoxyCodeLine{31 \};}
\DoxyCodeLine{32 }
\DoxyCodeLine{43 \textcolor{keyword}{template} <\textcolor{keyword}{typename} NonLinearOperatorImpl, \textcolor{keyword}{typename} \mbox{\hyperlink{a00316_ae747d502e8f67af4c5412d8a6febeb4c}{LinearSolver}} = utils::SolverDefault,}
\DoxyCodeLine{44           \textcolor{keyword}{typename} UpdateFunctionTypeImpl = utils::UpdateDefault>}
\DoxyCodeLine{45 \textcolor{keyword}{class }\mbox{\hyperlink{a01420}{NewtonRaphsonWithSubsidiaryFunction}} : \textcolor{keyword}{public} \mbox{\hyperlink{a01564}{IObservable}}<NonLinearSolverMessages>}
\DoxyCodeLine{46 \{}
\DoxyCodeLine{47 \textcolor{keyword}{public}:}
\DoxyCodeLine{49   \textcolor{keyword}{static} \textcolor{keyword}{constexpr} \textcolor{keywordtype}{bool} \mbox{\hyperlink{a01420_ad8df3b2ee18a76d69b531c7b6402970d}{isLinearSolver}} =}
\DoxyCodeLine{50       \mbox{\hyperlink{a01625}{Ikarus::Concepts::LinearSolverCheck}}<\mbox{\hyperlink{a00316_ae747d502e8f67af4c5412d8a6febeb4c}{LinearSolver}}, \textcolor{keyword}{typename} NonLinearOperatorImpl::DerivativeType,}
\DoxyCodeLine{51                                           \textcolor{keyword}{typename} NonLinearOperatorImpl::ValueType>;}
\DoxyCodeLine{52 }
\DoxyCodeLine{54   \textcolor{keyword}{using }\mbox{\hyperlink{a01420_a28457466df96034316437e231e9831df}{ValueType}} = \textcolor{keyword}{typename} NonLinearOperatorImpl::template ParameterValue<0>;}
\DoxyCodeLine{56   \textcolor{keyword}{using }\mbox{\hyperlink{a01420_a6f1cbb0e111b1621da367961fe6eb134}{UpdateFunctionType}} = UpdateFunctionTypeImpl;}
\DoxyCodeLine{57   \textcolor{keyword}{using }\mbox{\hyperlink{a01420_aa548756cad74bde3286938474f13023f}{NonLinearOperator}}  = NonLinearOperatorImpl; }
\DoxyCodeLine{58 }
\DoxyCodeLine{66   \textcolor{keyword}{explicit} \mbox{\hyperlink{a01420_a41f8e2bf25a62bb349cdaf8c8e4090da}{NewtonRaphsonWithSubsidiaryFunction}}(\textcolor{keyword}{const} NonLinearOperatorImpl\& p\_nonLinearOperator,}
\DoxyCodeLine{67                                                \mbox{\hyperlink{a01396}{LinearSolver}}\&\& p\_linearSolver       = \{\},}
\DoxyCodeLine{68                                                \mbox{\hyperlink{a01420_a6f1cbb0e111b1621da367961fe6eb134}{UpdateFunctionType}} p\_updateFunction = \{\})}
\DoxyCodeLine{69       : nonLinearOperator\_\{p\_nonLinearOperator\},}
\DoxyCodeLine{70         linearSolver\{std::move(p\_linearSolver)\},}
\DoxyCodeLine{71         updateFunction\{p\_updateFunction\} \{\}}
\DoxyCodeLine{72 }
\DoxyCodeLine{78   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01420_acadfca6b95ce86efde93b8dd3d12306a}{setup}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01416}{NewtonRaphsonWithSubsidiaryFunctionSettings}}\& p\_settings) \{ settings = p\_settings; \}}
\DoxyCodeLine{79 }
\DoxyCodeLine{80 \textcolor{preprocessor}{\#ifndef DOXYGEN}}
\DoxyCodeLine{81   \textcolor{keyword}{struct }NoPredictor}
\DoxyCodeLine{82   \{}
\DoxyCodeLine{83   \};}
\DoxyCodeLine{84 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{85 }
\DoxyCodeLine{96   \textcolor{keyword}{template} <\textcolor{keyword}{typename} SolutionType = NoPredictor, \textcolor{keyword}{typename} Subs\textcolor{keywordtype}{id}iaryType>}
\DoxyCodeLine{97   \textcolor{keyword}{requires} std::is\_same\_v<SolutionType, NoPredictor> ||}
\DoxyCodeLine{98            std::is\_convertible\_v<SolutionType, std::remove\_cvref\_t<typename NonLinearOperatorImpl::ValueType>>}
\DoxyCodeLine{99   [[nodiscard(}
\DoxyCodeLine{100       \textcolor{stringliteral}{"{}The solve method returns information of the solution process. You should store this information and check if "{}}}
\DoxyCodeLine{101       \textcolor{stringliteral}{"{}it was successful"{}})]] NonLinearSolverInformation}
\DoxyCodeLine{102   \mbox{\hyperlink{a01420_a8268fba35d7489060c9ee2974d079877}{solve}}(SubsidiaryType\& subsidiaryFunction, \mbox{\hyperlink{a01196}{SubsidiaryArgs}}\& subsidiaryArgs,}
\DoxyCodeLine{103         \textcolor{keyword}{const} SolutionType\& dx\_predictor = NoPredictor\{\}) \{}
\DoxyCodeLine{104     this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5afaee4ca3c30ee18148ce3ada37466498}{NonLinearSolverMessages::INIT}});}
\DoxyCodeLine{105 }
\DoxyCodeLine{107     \mbox{\hyperlink{a01424}{Ikarus::NonLinearSolverInformation}} solverInformation;}
\DoxyCodeLine{108     solverInformation.\mbox{\hyperlink{a01424_acb65d72d7b2291a9b0d958ce0e4e0887}{success}} = \textcolor{keyword}{true};}
\DoxyCodeLine{109     \textcolor{keyword}{auto}\& x                   = \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().firstParameter(); \textcolor{comment}{// x = D (Displacements)}}
\DoxyCodeLine{110     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (not std::is\_same\_v<SolutionType, NoPredictor>)}
\DoxyCodeLine{111       updateFunction(x, dx\_predictor);}
\DoxyCodeLine{112     \textcolor{keyword}{auto}\& lambda = \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().lastParameter();}
\DoxyCodeLine{113 }
\DoxyCodeLine{117 }
\DoxyCodeLine{118     \textcolor{keyword}{auto} lambdaDummy = lambda;}
\DoxyCodeLine{119     \textcolor{keyword}{auto} DDummy      = x;}
\DoxyCodeLine{120     x.setZero();}
\DoxyCodeLine{121     lambda = 1.0;}
\DoxyCodeLine{122     \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().template update<0>();}
\DoxyCodeLine{123     \textcolor{keyword}{const} \textcolor{keyword}{auto} Fext0 = (-\/\mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().value()).eval(); \textcolor{comment}{// dRdlambda(lambda)}}
\DoxyCodeLine{124     lambda           = lambdaDummy;}
\DoxyCodeLine{125     x                = DDummy;}
\DoxyCodeLine{126 }
\DoxyCodeLine{127     Eigen::MatrixX2<double> residual2d, sol2d;}
\DoxyCodeLine{128     \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().updateAll();}
\DoxyCodeLine{129     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& rx = \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().value();}
\DoxyCodeLine{130     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& Ax = \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().derivative();}
\DoxyCodeLine{131 }
\DoxyCodeLine{132     Eigen::VectorXd deltaD;}
\DoxyCodeLine{133     deltaD.resizeLike(rx);}
\DoxyCodeLine{134     deltaD.setZero();}
\DoxyCodeLine{135 }
\DoxyCodeLine{136     subsidiaryArgs.\mbox{\hyperlink{a01196_aa1bc7c1fc866571e3b6b22e14ed9afcf}{dfdDD}}.resizeLike(Fext0);}
\DoxyCodeLine{137 }
\DoxyCodeLine{138     subsidiaryFunction(subsidiaryArgs);}
\DoxyCodeLine{139     \textcolor{keyword}{auto} rNorm = sqrt(rx.dot(rx));}
\DoxyCodeLine{140     \textcolor{keyword}{decltype}(rNorm) dNorm;}
\DoxyCodeLine{141     \textcolor{keywordtype}{int} iter\{0\};}
\DoxyCodeLine{142     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\mbox{\hyperlink{a01420_ad8df3b2ee18a76d69b531c7b6402970d}{isLinearSolver}})}
\DoxyCodeLine{143       linearSolver.\mbox{\hyperlink{a01396_a33237d5e237bf2272d2c58c648eda5a1}{analyzePattern}}(Ax);}
\DoxyCodeLine{144 }
\DoxyCodeLine{146     \textcolor{keywordflow}{while} (rNorm > settings.\mbox{\hyperlink{a01416_a7e8e3668e5eca2b115ec77fcaabc8899}{tol}} \&\& iter < settings.\mbox{\hyperlink{a01416_a7ef35a86ec4e9a39bcc54182c5dc17b7}{maxIter}}) \{}
\DoxyCodeLine{147       this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5afdb2cb9832d112cd92fb2cda8879c3b4}{NonLinearSolverMessages::ITERATION\_STARTED}});}
\DoxyCodeLine{148 }
\DoxyCodeLine{150       residual2d.resize(rx.rows(), 2);}
\DoxyCodeLine{151       residual2d << -\/rx, Fext0;}
\DoxyCodeLine{152       sol2d.resize(rx.rows(), 2);}
\DoxyCodeLine{153 }
\DoxyCodeLine{154       \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\mbox{\hyperlink{a01420_ad8df3b2ee18a76d69b531c7b6402970d}{isLinearSolver}}) \{}
\DoxyCodeLine{155         linearSolver.\mbox{\hyperlink{a01396_ad9515d35c770a9d2a087a20593af5d85}{factorize}}(Ax);}
\DoxyCodeLine{156         linearSolver.\mbox{\hyperlink{a01396_a4ddf79d3353ecc1c7e7a25c7e249cb78}{solve}}(sol2d, residual2d);}
\DoxyCodeLine{157       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{158         sol2d = linearSolver(residual2d, Ax);}
\DoxyCodeLine{159       \}}
\DoxyCodeLine{160 }
\DoxyCodeLine{161       subsidiaryFunction(subsidiaryArgs);}
\DoxyCodeLine{162 }
\DoxyCodeLine{163       \textcolor{keyword}{const} \textcolor{keywordtype}{double} deltalambda = (-\/subsidiaryArgs.\mbox{\hyperlink{a01196_a628b23aa9e90c0e0ba1461ad2241645a}{f}} -\/ subsidiaryArgs.\mbox{\hyperlink{a01196_aa1bc7c1fc866571e3b6b22e14ed9afcf}{dfdDD}}.dot(sol2d.col(0))) /}
\DoxyCodeLine{164                                  (subsidiaryArgs.\mbox{\hyperlink{a01196_aa1bc7c1fc866571e3b6b22e14ed9afcf}{dfdDD}}.dot(sol2d.col(1)) + subsidiaryArgs.\mbox{\hyperlink{a01196_a198c4e48b353f1ebe5c5922bf51e34e5}{dfdDlambda}});}
\DoxyCodeLine{165       deltaD = sol2d.col(0) + deltalambda * sol2d.col(1);}
\DoxyCodeLine{166 }
\DoxyCodeLine{167       updateFunction(x, deltaD);}
\DoxyCodeLine{168       updateFunction(subsidiaryArgs.\mbox{\hyperlink{a01196_afc97f3ae46ddd6a208b90d253aa8a7e6}{DD}}, deltaD);}
\DoxyCodeLine{169 }
\DoxyCodeLine{170       lambda += deltalambda;}
\DoxyCodeLine{171       subsidiaryArgs.\mbox{\hyperlink{a01196_a0cd5cc302f164ea614b9edfadd7c82c9}{Dlambda}} += deltalambda;}
\DoxyCodeLine{172 }
\DoxyCodeLine{173       dNorm = sqrt(deltaD.dot(deltaD) + deltalambda * deltalambda);}
\DoxyCodeLine{174       \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}().updateAll();}
\DoxyCodeLine{175       rNorm = sqrt(rx.dot(rx) + subsidiaryArgs.\mbox{\hyperlink{a01196_a628b23aa9e90c0e0ba1461ad2241645a}{f}} * subsidiaryArgs.\mbox{\hyperlink{a01196_a628b23aa9e90c0e0ba1461ad2241645a}{f}});}
\DoxyCodeLine{176 }
\DoxyCodeLine{177       this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5a0d30d757bf062e88728ebe7f8e2b2577}{NonLinearSolverMessages::SOLUTION\_CHANGED}}, \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(lambda));}
\DoxyCodeLine{178       this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5a07a63a77745ab72a7e89fb22a8bcfd78}{NonLinearSolverMessages::CORRECTIONNORM\_UPDATED}}, \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(dNorm));}
\DoxyCodeLine{179       this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5a721c68980ba6c47122945477a56d7a14}{NonLinearSolverMessages::RESIDUALNORM\_UPDATED}}, \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{double}\textcolor{keyword}{>}(rNorm));}
\DoxyCodeLine{180       this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5a073d71a89cce6d4b9775987fdbb22815}{NonLinearSolverMessages::ITERATION\_ENDED}});}
\DoxyCodeLine{181 }
\DoxyCodeLine{182       ++iter;}
\DoxyCodeLine{183     \}}
\DoxyCodeLine{184 }
\DoxyCodeLine{185     \textcolor{keywordflow}{if} (iter == settings.\mbox{\hyperlink{a01416_a7ef35a86ec4e9a39bcc54182c5dc17b7}{maxIter}})}
\DoxyCodeLine{186       solverInformation.\mbox{\hyperlink{a01424_acb65d72d7b2291a9b0d958ce0e4e0887}{success}} = \textcolor{keyword}{false};}
\DoxyCodeLine{187     solverInformation.\mbox{\hyperlink{a01424_a81570cd3d9f6589a4d1ba81211f41b99}{iterations}}     = iter;}
\DoxyCodeLine{188     solverInformation.\mbox{\hyperlink{a01424_ab09859737734f97734f20624f9f3c934}{residualNorm}}   = rNorm;}
\DoxyCodeLine{189     solverInformation.\mbox{\hyperlink{a01424_a66f51414779f3e563557157fb688f18b}{correctionNorm}} = dNorm;}
\DoxyCodeLine{190     \textcolor{keywordflow}{if} (solverInformation.\mbox{\hyperlink{a01424_acb65d72d7b2291a9b0d958ce0e4e0887}{success}})}
\DoxyCodeLine{191       this-\/>\mbox{\hyperlink{a01564_a4bce3750aa7d52aff9baf122a54e16b5}{notify}}(\mbox{\hyperlink{a00310_gga662b2b6a80547adf4b9ce8b30d87fab5a15380ac35d47cdbcbd64aada4bc21931}{NonLinearSolverMessages::FINISHED\_SUCESSFULLY}}, iter);}
\DoxyCodeLine{192 }
\DoxyCodeLine{193     \textcolor{keywordflow}{return} solverInformation;}
\DoxyCodeLine{194   \}}
\DoxyCodeLine{195 }
\DoxyCodeLine{200   \textcolor{keyword}{auto}\& \mbox{\hyperlink{a01420_a11cdacd88c7d199ecc8be67d0d21c298}{nonLinearOperator}}() \{ \textcolor{keywordflow}{return} nonLinearOperator\_; \}}
\DoxyCodeLine{201 }
\DoxyCodeLine{202 \textcolor{keyword}{private}:}
\DoxyCodeLine{203   NonLinearOperatorImpl nonLinearOperator\_;}
\DoxyCodeLine{204   \mbox{\hyperlink{a01396}{LinearSolver}} linearSolver;}
\DoxyCodeLine{205   \mbox{\hyperlink{a01420_a6f1cbb0e111b1621da367961fe6eb134}{UpdateFunctionType}} updateFunction;}
\DoxyCodeLine{206   \mbox{\hyperlink{a01416}{NewtonRaphsonWithSubsidiaryFunctionSettings}} settings;}
\DoxyCodeLine{207 \};}
\DoxyCodeLine{208 }
\DoxyCodeLine{219 \textcolor{keyword}{template} <\textcolor{keyword}{typename} NonLinearOperatorImpl, \textcolor{keyword}{typename} \mbox{\hyperlink{a00316_ae747d502e8f67af4c5412d8a6febeb4c}{LinearSolver}} = utils::SolverDefault,}
\DoxyCodeLine{220           \textcolor{keyword}{typename} UpdateFunctionType = utils::UpdateDefault>}
\DoxyCodeLine{221 \textcolor{keyword}{auto} \mbox{\hyperlink{a00316_a674c58e9e3dd89675adb727587a08850}{makeNewtonRaphsonWithSubsidiaryFunction}}(\textcolor{keyword}{const} NonLinearOperatorImpl\& p\_nonLinearOperator,}
\DoxyCodeLine{222                                              \mbox{\hyperlink{a01396}{LinearSolver}}\&\& p\_linearSolver         = \{\},}
\DoxyCodeLine{223                                              UpdateFunctionType\&\& p\_updateFunction = \{\}) \{}
\DoxyCodeLine{224   \textcolor{keywordflow}{return} std::make\_shared<NewtonRaphsonWithSubsidiaryFunction<NonLinearOperatorImpl, LinearSolver, UpdateFunctionType>>(}
\DoxyCodeLine{225       p\_nonLinearOperator, std::forward<LinearSolver>(p\_linearSolver), std::move(p\_updateFunction));}
\DoxyCodeLine{226 \}}
\DoxyCodeLine{227 \} \textcolor{comment}{// namespace Ikarus}}

\end{DoxyCode}
