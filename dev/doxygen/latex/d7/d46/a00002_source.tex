\hypertarget{a00002_source}{}\doxysection{autodifffe.\+hh}
\label{a00002_source}\index{autodifffe.hh@{autodifffe.hh}}
\mbox{\hyperlink{a00002}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// SPDX-\/FileCopyrightText: 2021-\/2024 The Ikarus Developers mueller@ibb.uni-\/stuttgart.de}}
\DoxyCodeLine{2 \textcolor{comment}{// SPDX-\/License-\/Identifier: LGPL-\/3.0-\/or-\/later}}
\DoxyCodeLine{3 }
\DoxyCodeLine{5 \textcolor{comment}{//}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include <autodiff/forward/dual/dual.hpp>}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <autodiff/forward/dual/eigen.hpp>}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00020}{ikarus/finiteelements/ferequirements.hh}}>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00014}{ikarus/finiteelements/physicshelper.hh}}>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00149}{ikarus/utils/traits.hh}}>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{keyword}{namespace }\mbox{\hyperlink{a00219}{Ikarus}} \{}
\DoxyCodeLine{15   \textcolor{keyword}{template} <\textcolor{keyword}{typename} RealElement, \textcolor{keyword}{typename} FERequirementType\_ = FErequirements<>, \textcolor{keywordtype}{bool} useEigenRef = false,}
\DoxyCodeLine{16             \textcolor{keywordtype}{bool} forceAutoDiff = false>}
\DoxyCodeLine{17   \textcolor{keyword}{class }\mbox{\hyperlink{a01113}{AutoDiffFE}} : \textcolor{keyword}{public} RealElement \{}
\DoxyCodeLine{18   \textcolor{keyword}{public}:}
\DoxyCodeLine{19     \textcolor{keyword}{using }\mbox{\hyperlink{a01113_afcfea2bc35bc5a8e2fdcff34671ef9cc}{Base}}              = RealElement;}
\DoxyCodeLine{20     \textcolor{keyword}{using }\mbox{\hyperlink{a01113_a3665b1e498bf978ee2b65aa76800ea6e}{Basis}}             = Base::Basis;}
\DoxyCodeLine{21     \textcolor{keyword}{using }\mbox{\hyperlink{a01113_ad13ddf2ec70fed5d8c3f1a3d44425a5c}{LocalView}}         = \textcolor{keyword}{typename} Basis::FlatBasis::LocalView;}
\DoxyCodeLine{22     \textcolor{keyword}{using }\mbox{\hyperlink{a01185}{Traits}}            = \mbox{\hyperlink{a01185}{TraitsFromLocalView<LocalView, useEigenRef>}};}
\DoxyCodeLine{23     \textcolor{keyword}{using }\mbox{\hyperlink{a01113_a56d87315532397564bc7b0f28d4ce8cf}{Element}}           = \textcolor{keyword}{typename} LocalView::Element;}
\DoxyCodeLine{24     \textcolor{keyword}{using }\mbox{\hyperlink{a01113_a08f8ca2c88734955a759b3f6572c46a1}{FERequirementType}} = FERequirementType\_;}
\DoxyCodeLine{25 }
\DoxyCodeLine{26     \textcolor{keywordtype}{void} \mbox{\hyperlink{a01113_a2056589d04097f6e1ebc9ed47e72848d}{calculateMatrix}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01113_a08f8ca2c88734955a759b3f6572c46a1}{FERequirementType}}\& par, \textcolor{keyword}{typename} Traits::template MatrixType<> h)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{27       \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ RealElement::calculateMatrix(par, h); \} and not forceAutoDiff) \{}
\DoxyCodeLine{28         RealElement::calculateMatrix(par, h);}
\DoxyCodeLine{29       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{30                              this-\/>\textcolor{keyword}{template} calculateVectorImpl<autodiff::dual>(}
\DoxyCodeLine{31                                  par, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<autodiff::dual>>(),}
\DoxyCodeLine{32                                  std::declval<const Eigen::VectorXdual\&>());}
\DoxyCodeLine{33                            \}) \{}
\DoxyCodeLine{36         Eigen::VectorXdual dx(this-\/>localView().size());}
\DoxyCodeLine{37         Eigen::VectorXdual g(this-\/>localView().size());}
\DoxyCodeLine{38         dx.setZero();}
\DoxyCodeLine{39         \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) -\/> \textcolor{keyword}{auto}\& \{}
\DoxyCodeLine{40           g.setZero();}
\DoxyCodeLine{41           this-\/>\textcolor{keyword}{template} calculateVectorImpl<autodiff::dual>(par, g, x);}
\DoxyCodeLine{42           \textcolor{keywordflow}{return} g;}
\DoxyCodeLine{43         \};}
\DoxyCodeLine{44         jacobian(f, autodiff::wrt(dx), at(dx), g, h);}
\DoxyCodeLine{45       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{46                              this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual2nd>(}
\DoxyCodeLine{47                                  par, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<autodiff::dual2nd>>());}
\DoxyCodeLine{48                            \}) \{}
\DoxyCodeLine{49         Eigen::VectorXdual2nd dx(this-\/>localView().size());}
\DoxyCodeLine{50         Eigen::VectorXd g;}
\DoxyCodeLine{51         autodiff::dual2nd e;}
\DoxyCodeLine{52         dx.setZero();}
\DoxyCodeLine{53         \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual2nd>(par, x); \};}
\DoxyCodeLine{54         hessian(f, autodiff::wrt(dx), at(dx), e, g, h);}
\DoxyCodeLine{55       \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{56         \textcolor{keyword}{static\_assert}(\mbox{\hyperlink{a01549}{Ikarus::Std::DummyFalse<AutoDiffFE>::value}},}
\DoxyCodeLine{57                       \textcolor{stringliteral}{"{}Appropriate calculateScalarImpl or calculateVectorImpl functions are not implemented for the "{}}}
\DoxyCodeLine{58                       \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{59     \}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61     \textcolor{keyword}{inline} \textcolor{keywordtype}{void} \mbox{\hyperlink{a01113_a1f9364201f449c6eda30962fd3b1492e}{calculateVector}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01113_a08f8ca2c88734955a759b3f6572c46a1}{FERequirementType}}\& par, \textcolor{keyword}{typename} Traits::template VectorType<> g)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{62       \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{63                       this-\/>\textcolor{keyword}{template} calculateVectorImpl<double>(}
\DoxyCodeLine{64                           par, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<double>>(),}
\DoxyCodeLine{65                           std::declval<const Eigen::VectorXd\&>());}
\DoxyCodeLine{66                     \}}
\DoxyCodeLine{67                     and not forceAutoDiff) \{}
\DoxyCodeLine{68         \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateVectorImpl<double>(par, g);}
\DoxyCodeLine{69       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{70                              this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual>(}
\DoxyCodeLine{71                                  par, std::declval<const Eigen::VectorXdual\&>());}
\DoxyCodeLine{72                            \}) \{}
\DoxyCodeLine{73         Eigen::VectorXdual dx(this-\/>localView().size());}
\DoxyCodeLine{74         dx.setZero();}
\DoxyCodeLine{75         autodiff::dual e;}
\DoxyCodeLine{76         \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual>(par, x); \};}
\DoxyCodeLine{77         gradient(f, autodiff::wrt(dx), at(dx), e, g);}
\DoxyCodeLine{78       \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{79         \textcolor{keyword}{static\_assert}(\mbox{\hyperlink{a01549}{Ikarus::Std::DummyFalse<AutoDiffFE>::value}},}
\DoxyCodeLine{80                       \textcolor{stringliteral}{"{}Appropriate calculateScalarImpl function is not implemented for the "{}}}
\DoxyCodeLine{81                       \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{82     \}}
\DoxyCodeLine{83 }
\DoxyCodeLine{84     \textcolor{keywordtype}{void} \mbox{\hyperlink{a01113_a68f24f1425ffade7f06b7793ba0427d4}{calculateLocalSystem}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01113_a08f8ca2c88734955a759b3f6572c46a1}{FERequirementType}}\& par, \textcolor{keyword}{typename} Traits::template MatrixType<> h,}
\DoxyCodeLine{85                               \textcolor{keyword}{typename} Traits::template VectorType<> g)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{86       Eigen::VectorXdual2nd dx(this-\/>localView().size());}
\DoxyCodeLine{87       dx.setZero();}
\DoxyCodeLine{88       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>calculateScalarImpl(par, x); \};}
\DoxyCodeLine{89       hessian(f, autodiff::wrt(dx), at(dx), g, h);}
\DoxyCodeLine{90     \}}
\DoxyCodeLine{91 }
\DoxyCodeLine{92     [[nodiscard]] \textcolor{keywordtype}{double} \mbox{\hyperlink{a01113_a392e9a000482eec8da1647644ede70dc}{calculateScalar}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01113_a08f8ca2c88734955a759b3f6572c46a1}{FERequirementType}}\& par)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{93       \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ RealElement::calculateScalar(par); \}) \{}
\DoxyCodeLine{94         \textcolor{keywordflow}{return} RealElement::calculateScalar(par);}
\DoxyCodeLine{95       \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ this-\/>calculateScalarImpl(par); \}) \{}
\DoxyCodeLine{96         \textcolor{keywordflow}{return} this-\/>calculateScalarImpl(par);}
\DoxyCodeLine{97       \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{98         \textcolor{keyword}{static\_assert}(\mbox{\hyperlink{a01549}{Ikarus::Std::DummyFalse<AutoDiffFE>::value}},}
\DoxyCodeLine{99                       \textcolor{stringliteral}{"{}Appropriate calculateScalar and calculateScalarImpl functions are not implemented for the "{}}}
\DoxyCodeLine{100                       \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{101     \}}
\DoxyCodeLine{102 }
\DoxyCodeLine{103     \textcolor{keyword}{const} RealElement\& \mbox{\hyperlink{a01113_a072df3750e1580dfe52fa27c771b8f28}{getFE}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} *\textcolor{keyword}{this}; \}}
\DoxyCodeLine{104 }
\DoxyCodeLine{105     \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Args>}
\DoxyCodeLine{106     \textcolor{keyword}{explicit} \mbox{\hyperlink{a01113_ad981a82e4d983f5f43106742d02c1617}{AutoDiffFE}}(Args\&\&... args) : RealElement\{std::forward<Args>(args)...\} \{\}}
\DoxyCodeLine{107   \};}
\DoxyCodeLine{108 \}  \textcolor{comment}{// namespace Ikarus}}

\end{DoxyCode}
