\hypertarget{a00203_source}{}\doxysection{enhancedassumedstrains.\+hh}
\label{a00203_source}\index{enhancedassumedstrains.hh@{enhancedassumedstrains.hh}}
\mbox{\hyperlink{a00203}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// SPDX-\/FileCopyrightText: 2021-\/2024 The Ikarus Developers mueller@ibb.uni-\/stuttgart.de}}
\DoxyCodeLine{2 \textcolor{comment}{// SPDX-\/License-\/Identifier: LGPL-\/3.0-\/or-\/later}}
\DoxyCodeLine{3 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#if HAVE\_DUNE\_LOCALFEFUNCTIONS}}
\DoxyCodeLine{12 \textcolor{preprocessor}{  \#include <dune/localfefunctions/derivativetransformators.hh>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{  \#include <dune/localfefunctions/linearAlgebraHelper.hh>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{  \#include <dune/localfefunctions/meta.hh>}}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{preprocessor}{  \#include <\mbox{\hyperlink{a00170}{ikarus/finiteelements/fehelper.hh}}>}}
\DoxyCodeLine{17 \textcolor{preprocessor}{  \#include <\mbox{\hyperlink{a00236}{ikarus/finiteelements/ferequirements.hh}}>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{  \#include <\mbox{\hyperlink{a00227}{ikarus/finiteelements/mechanics/easvariants.hh}}>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{  \#include <\mbox{\hyperlink{a00026}{ikarus/utils/eigendunetransformations.hh}}>}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{keyword}{namespace }\mbox{\hyperlink{a00325}{Ikarus}} \{}
\DoxyCodeLine{22 }
\DoxyCodeLine{32 \textcolor{keyword}{template} <\textcolor{keyword}{typename} DisplacementBasedElement>}
\DoxyCodeLine{33 \textcolor{keyword}{class }\mbox{\hyperlink{a01294}{EnhancedAssumedStrains}} : \textcolor{keyword}{public} DisplacementBasedElement}
\DoxyCodeLine{34 \{}
\DoxyCodeLine{35 \textcolor{keyword}{public}:}
\DoxyCodeLine{36   \textcolor{keyword}{using }\mbox{\hyperlink{a01294_a5a888bacae06491a7e890c9424518f25}{FERequirementType}}      = \textcolor{keyword}{typename} DisplacementBasedElement::FERequirementType;}
\DoxyCodeLine{37   \textcolor{keyword}{using }\mbox{\hyperlink{a01294_a5ed0cee3df4cbf8a9aed6a705dd8642e}{ResultRequirementsType}} = \textcolor{keyword}{typename} DisplacementBasedElement::ResultRequirementsType;}
\DoxyCodeLine{38   \textcolor{keyword}{using }\mbox{\hyperlink{a01294_a5699ce520159375f9737ec518130e50e}{LocalView}}              = \textcolor{keyword}{typename} DisplacementBasedElement::LocalView;}
\DoxyCodeLine{39   \textcolor{keyword}{using }\mbox{\hyperlink{a01294_a429fd3bd9c0252bb90bdee6d124518c0}{Geometry}}               = \textcolor{keyword}{typename} DisplacementBasedElement::Geometry;}
\DoxyCodeLine{40   \textcolor{keyword}{using }\mbox{\hyperlink{a01294_aee26978267fb07c5c013a33bbc85f380}{GridView}}               = \textcolor{keyword}{typename} DisplacementBasedElement::GridView;}
\DoxyCodeLine{41   \textcolor{keyword}{using }\mbox{\hyperlink{a01294_a550c9fb8dcd8c64d21c9adaf4749c866}{Traits}}                 = \textcolor{keyword}{typename} DisplacementBasedElement::Traits;}
\DoxyCodeLine{42   \textcolor{keyword}{using }DisplacementBasedElement::localView;}
\DoxyCodeLine{43 }
\DoxyCodeLine{52   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Args>}
\DoxyCodeLine{53   \textcolor{keyword}{requires}(}
\DoxyCodeLine{54       not std::is\_same\_v<std::remove\_cvref\_t<std::tuple\_element\_t<0, std::tuple<Args...>>>, \mbox{\hyperlink{a01294}{EnhancedAssumedStrains}}>)}
\DoxyCodeLine{55   \textcolor{keyword}{explicit} \mbox{\hyperlink{a01294_a1405d5a39d16aaed2a794b4bbbc75039}{EnhancedAssumedStrains}}(Args\&\&... args)}
\DoxyCodeLine{56       : DisplacementBasedElement(std::forward<Args>(args)...) \{\}}
\DoxyCodeLine{57 }
\DoxyCodeLine{66   \textcolor{keywordtype}{double} \mbox{\hyperlink{a01294_aa455935bfd539dbd145450c9e8732bdc}{calculateScalar}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01294_a5a888bacae06491a7e890c9424518f25}{FERequirementType}}\& par)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{67     \textcolor{keywordflow}{if} (\mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}())}
\DoxyCodeLine{68       \textcolor{keywordflow}{return} DisplacementBasedElement::calculateScalar(par);}
\DoxyCodeLine{69     DUNE\_THROW(Dune::NotImplemented,}
\DoxyCodeLine{70                \textcolor{stringliteral}{"{}EAS element do not support any scalar calculations, i.e. they are not derivable from a potential"{}});}
\DoxyCodeLine{71   \}}
\DoxyCodeLine{72 }
\DoxyCodeLine{78   \textcolor{keywordtype}{bool} \mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} std::holds\_alternative<std::monostate>(easVariant\_); \}}
\DoxyCodeLine{79 }
\DoxyCodeLine{88   \textcolor{keyword}{inline} \textcolor{keywordtype}{void} \mbox{\hyperlink{a01294_a3a92d4669635a5ab22a10bc353111d95}{calculateVector}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01294_a5a888bacae06491a7e890c9424518f25}{FERequirementType}}\& par, \textcolor{keyword}{typename} Traits::template VectorType<> force)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{89     calculateVectorImpl<double>(par, force);}
\DoxyCodeLine{90   \}}
\DoxyCodeLine{91 }
\DoxyCodeLine{97   \textcolor{keyword}{const} \textcolor{keyword}{auto}\& \mbox{\hyperlink{a01294_ab8c3ff043b0808de14656d79ec56de5f}{easVariant}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} easVariant\_; \}}
\DoxyCodeLine{98 }
\DoxyCodeLine{104   \textcolor{keyword}{auto} \mbox{\hyperlink{a01294_aa75e2ef6c92f084608e36d5aa6a1122e}{getNumberOfEASParameters}}()\textcolor{keyword}{ const }\{}
\DoxyCodeLine{105     \textcolor{keywordflow}{return} std::visit(}
\DoxyCodeLine{106         [\&]<\textcolor{keyword}{typename} EAST>(\textcolor{keyword}{const} EAST\&) \{}
\DoxyCodeLine{107           \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (std::is\_same\_v<std::monostate, EAST>)}
\DoxyCodeLine{108             \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{109           \textcolor{keywordflow}{else}}
\DoxyCodeLine{110             \textcolor{keywordflow}{return} EAST::enhancedStrainSize;}
\DoxyCodeLine{111         \},}
\DoxyCodeLine{112         easVariant\_);}
\DoxyCodeLine{113   \}}
\DoxyCodeLine{114 }
\DoxyCodeLine{123   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01294_a7f2216c3b8f6b94145ae586324018376}{calculateMatrix}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01294_a5a888bacae06491a7e890c9424518f25}{FERequirementType}}\& par, \textcolor{keyword}{typename} Traits::template MatrixType<> K)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{124     \textcolor{keyword}{using namespace }Dune::DerivativeDirections;}
\DoxyCodeLine{125     \textcolor{keyword}{using namespace }\mbox{\hyperlink{a00331}{Dune}};}
\DoxyCodeLine{126 }
\DoxyCodeLine{130     DisplacementBasedElement::calculateMatrix(par, K);}
\DoxyCodeLine{131 }
\DoxyCodeLine{132     \textcolor{keywordflow}{if} (\mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}())}
\DoxyCodeLine{133       \textcolor{keywordflow}{return};}
\DoxyCodeLine{134 }
\DoxyCodeLine{135     std::visit(}
\DoxyCodeLine{136         [\&]<\textcolor{keyword}{typename} EAST>(\textcolor{keyword}{const} EAST\& easFunction) \{}
\DoxyCodeLine{137           \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (not std::is\_same\_v<std::monostate, EAST>) \{}
\DoxyCodeLine{138             \textcolor{keyword}{constexpr} \textcolor{keywordtype}{int} enhancedStrainSize = EAST::enhancedStrainSize;}
\DoxyCodeLine{139             Eigen::Matrix<double, enhancedStrainSize, enhancedStrainSize> D;}
\DoxyCodeLine{140             calculateDAndLMatrix(easFunction, par, D, L);}
\DoxyCodeLine{141 }
\DoxyCodeLine{142             K.template triangularView<Eigen::Upper>() -\/= L.transpose() * D.inverse() * L;}
\DoxyCodeLine{143             K.template triangularView<Eigen::StrictlyLower>() = K.transpose();}
\DoxyCodeLine{144           \}}
\DoxyCodeLine{145         \},}
\DoxyCodeLine{146         easVariant\_);}
\DoxyCodeLine{147   \}}
\DoxyCodeLine{148 }
\DoxyCodeLine{163   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01294_a22e25753bb3cf0c5b296c3af10c443b6}{calculateAt}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01294_a5ed0cee3df4cbf8a9aed6a705dd8642e}{ResultRequirementsType}}\& req, \textcolor{keyword}{const} \mbox{\hyperlink{a01378}{Dune::FieldVector<double, Traits::mydim>}}\& local,}
\DoxyCodeLine{164                    \mbox{\hyperlink{a01258}{ResultTypeMap<double>}}\& result)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{165     \textcolor{keyword}{using namespace }Dune::Indices;}
\DoxyCodeLine{166     \textcolor{keyword}{using namespace }Dune::DerivativeDirections;}
\DoxyCodeLine{167     \textcolor{keyword}{using namespace }\mbox{\hyperlink{a00331}{Dune}};}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     DisplacementBasedElement::calculateAt(req, local, result);}
\DoxyCodeLine{170 }
\DoxyCodeLine{171     \textcolor{keywordflow}{if} (\mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}())}
\DoxyCodeLine{172       \textcolor{keywordflow}{return};}
\DoxyCodeLine{173 }
\DoxyCodeLine{174     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& par           = req.getFERequirements();}
\DoxyCodeLine{175     \textcolor{keyword}{const} \textcolor{keyword}{auto} C              = DisplacementBasedElement::materialTangentFunction(req.getFERequirements());}
\DoxyCodeLine{176     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& numberOfNodes = DisplacementBasedElement::numberOfNodes();}
\DoxyCodeLine{177     \textcolor{keyword}{auto} uFunction            = DisplacementBasedElement::displacementFunction(par);}
\DoxyCodeLine{178     \textcolor{keyword}{const} \textcolor{keyword}{auto} disp           = \mbox{\hyperlink{a00320_ga545d74839895f4576a3b8c97d72abefd}{Dune::viewAsFlatEigenVector}}(uFunction.coefficientsRef());}
\DoxyCodeLine{179 }
\DoxyCodeLine{180     std::visit(}
\DoxyCodeLine{181         [\&]<\textcolor{keyword}{typename} EAST>(\textcolor{keyword}{const} EAST\& easFunction) \{}
\DoxyCodeLine{182           \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (not std::is\_same\_v<std::monostate, EAST>) \{}
\DoxyCodeLine{183             \textcolor{keyword}{constexpr} \textcolor{keywordtype}{int} enhancedStrainSize = EAST::enhancedStrainSize;}
\DoxyCodeLine{184             Eigen::Matrix<double, enhancedStrainSize, enhancedStrainSize> D;}
\DoxyCodeLine{185             calculateDAndLMatrix(easFunction, req.getFERequirements(), D, L);}
\DoxyCodeLine{186             \textcolor{keyword}{const} \textcolor{keyword}{auto} alpha = (-\/D.inverse() * L * disp).eval();}
\DoxyCodeLine{187             \textcolor{keyword}{const} \textcolor{keyword}{auto} M     = easFunction.calcM(local);}
\DoxyCodeLine{188             \textcolor{keyword}{const} \textcolor{keyword}{auto} CEval = C(local);}
\DoxyCodeLine{189             \textcolor{keyword}{auto} easStress   = (CEval * M * alpha).eval();}
\DoxyCodeLine{190             \textcolor{keyword}{typename} \mbox{\hyperlink{a01258_a72132ad19ec7049750ba2c4f60cde93f}{ResultTypeMap<double>::ResultArray}} resultVector;}
\DoxyCodeLine{191             \textcolor{keywordflow}{if} (req.isResultRequested(\mbox{\hyperlink{a00312_gga531be167e924b749eb8b4ccc7f1c18c9ad8cbb8fe32024cc3f1376a24d27aeae7}{ResultType::linearStress}})) \{}
\DoxyCodeLine{192               resultVector.resize(3, 1);}
\DoxyCodeLine{193               resultVector = result.\mbox{\hyperlink{a01258_a7f9a61700e42a5507d7dfcfd059a4067}{getResult}}(\mbox{\hyperlink{a00312_gga531be167e924b749eb8b4ccc7f1c18c9ad8cbb8fe32024cc3f1376a24d27aeae7}{ResultType::linearStress}}) + easStress;}
\DoxyCodeLine{194               result.\mbox{\hyperlink{a01258_aa399a96000daf40950e388eb0b23a7c0}{insertOrAssignResult}}(\mbox{\hyperlink{a00312_gga531be167e924b749eb8b4ccc7f1c18c9ad8cbb8fe32024cc3f1376a24d27aeae7}{ResultType::linearStress}}, resultVector);}
\DoxyCodeLine{195             \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{196               DUNE\_THROW(Dune::NotImplemented, \textcolor{stringliteral}{"{}The requested result type is NOT implemented."{}});}
\DoxyCodeLine{197           \}}
\DoxyCodeLine{198         \},}
\DoxyCodeLine{199         easVariant\_);}
\DoxyCodeLine{200   \}}
\DoxyCodeLine{201 }
\DoxyCodeLine{207   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01294_a3990ba9792f807ae9d0c2f5fd7fb7e85}{setEASType}}(\textcolor{keywordtype}{int} numberOfEASParameters\_) \{}
\DoxyCodeLine{208     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& numberOfNodes = DisplacementBasedElement::numberOfNodes();}
\DoxyCodeLine{209     \textcolor{keywordflow}{if} (not((numberOfNodes == 4 and Traits::mydim == 2) or (numberOfNodes == 8 and Traits::mydim == 3)) and}
\DoxyCodeLine{210         (not \mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}()))}
\DoxyCodeLine{211       DUNE\_THROW(Dune::NotImplemented, \textcolor{stringliteral}{"{}EAS only supported for Q1 or H1 elements"{}});}
\DoxyCodeLine{212 }
\DoxyCodeLine{213     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (Traits::mydim == 2) \{}
\DoxyCodeLine{214       \textcolor{keywordflow}{switch} (numberOfEASParameters\_) \{}
\DoxyCodeLine{215         \textcolor{keywordflow}{case} 0:}
\DoxyCodeLine{216           easVariant\_ = std::monostate();}
\DoxyCodeLine{217           \textcolor{keywordflow}{break};}
\DoxyCodeLine{218         \textcolor{keywordflow}{case} 4:}
\DoxyCodeLine{219           easVariant\_ = \mbox{\hyperlink{a01270}{EAS::Q1E4}}(localView().element().geometry());}
\DoxyCodeLine{220           \textcolor{keywordflow}{break};}
\DoxyCodeLine{221         \textcolor{keywordflow}{case} 5:}
\DoxyCodeLine{222           easVariant\_ = \mbox{\hyperlink{a01274}{EAS::Q1E5}}(localView().element().geometry());}
\DoxyCodeLine{223           \textcolor{keywordflow}{break};}
\DoxyCodeLine{224         \textcolor{keywordflow}{case} 7:}
\DoxyCodeLine{225           easVariant\_ = \mbox{\hyperlink{a01278}{EAS::Q1E7}}(localView().element().geometry());}
\DoxyCodeLine{226           \textcolor{keywordflow}{break};}
\DoxyCodeLine{227         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{228           DUNE\_THROW(Dune::NotImplemented, \textcolor{stringliteral}{"{}The given EAS parameters are not available for the 2D case."{}});}
\DoxyCodeLine{229           \textcolor{keywordflow}{break};}
\DoxyCodeLine{230       \}}
\DoxyCodeLine{231     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (Traits::mydim == 3) \{}
\DoxyCodeLine{232       \textcolor{keywordflow}{switch} (numberOfEASParameters\_) \{}
\DoxyCodeLine{233         \textcolor{keywordflow}{case} 0:}
\DoxyCodeLine{234           easVariant\_ = std::monostate();}
\DoxyCodeLine{235           \textcolor{keywordflow}{break};}
\DoxyCodeLine{236         \textcolor{keywordflow}{case} 9:}
\DoxyCodeLine{237           easVariant\_ = \mbox{\hyperlink{a01282}{EAS::H1E9}}(localView().element().geometry());}
\DoxyCodeLine{238           \textcolor{keywordflow}{break};}
\DoxyCodeLine{239         \textcolor{keywordflow}{case} 21:}
\DoxyCodeLine{240           easVariant\_ = \mbox{\hyperlink{a01286}{EAS::H1E21}}(localView().element().geometry());}
\DoxyCodeLine{241           \textcolor{keywordflow}{break};}
\DoxyCodeLine{242         \textcolor{keywordflow}{default}:}
\DoxyCodeLine{243           DUNE\_THROW(Dune::NotImplemented, \textcolor{stringliteral}{"{}The given EAS parameters are not available for the 3D case."{}});}
\DoxyCodeLine{244           \textcolor{keywordflow}{break};}
\DoxyCodeLine{245       \}}
\DoxyCodeLine{246     \}}
\DoxyCodeLine{247   \}}
\DoxyCodeLine{248 }
\DoxyCodeLine{249 \textcolor{keyword}{protected}:}
\DoxyCodeLine{250   \textcolor{keyword}{template} <\textcolor{keyword}{typename} ScalarType>}
\DoxyCodeLine{251   \textcolor{keyword}{inline} ScalarType \mbox{\hyperlink{a01294_afc5adc55bc187c5d033a90cbae91ae44}{calculateScalarImpl}}(}
\DoxyCodeLine{252       \textcolor{keyword}{const} \mbox{\hyperlink{a01294_a5a888bacae06491a7e890c9424518f25}{FERequirementType}}\& par, \textcolor{keyword}{const} std::optional<\textcolor{keyword}{const} Eigen::VectorX<ScalarType>>\& dx = std::nullopt)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{253     \textcolor{keywordflow}{if} (\mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}())}
\DoxyCodeLine{254       \textcolor{keywordflow}{return} DisplacementBasedElement::template calculateScalarImpl<ScalarType>(par, dx);}
\DoxyCodeLine{255     DUNE\_THROW(Dune::NotImplemented,}
\DoxyCodeLine{256                \textcolor{stringliteral}{"{}EAS element do not support any scalar calculations, i.e. they are not derivable from a potential"{}});}
\DoxyCodeLine{257   \}}
\DoxyCodeLine{258 }
\DoxyCodeLine{259   \textcolor{keyword}{template} <\textcolor{keyword}{typename} ScalarType>}
\DoxyCodeLine{260   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01294_afa32c429e6121e0573a0fedbe43d2f45}{calculateVectorImpl}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01294_a5a888bacae06491a7e890c9424518f25}{FERequirementType}}\& par, \textcolor{keyword}{typename} Traits::template VectorType<ScalarType> force,}
\DoxyCodeLine{261                            \textcolor{keyword}{const} std::optional<\textcolor{keyword}{const} Eigen::VectorX<ScalarType>>\& dx = std::nullopt)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{262     DisplacementBasedElement::calculateVectorImpl(par, force, dx);}
\DoxyCodeLine{263     \textcolor{keywordflow}{if} (\mbox{\hyperlink{a01294_a27a311be4e36cbb8d68d96e6d9046afd}{isDisplacementBased}}())}
\DoxyCodeLine{264       \textcolor{keywordflow}{return};}
\DoxyCodeLine{265     \textcolor{keyword}{using namespace }\mbox{\hyperlink{a00331}{Dune}};}
\DoxyCodeLine{266     \textcolor{keyword}{const} \textcolor{keyword}{auto} uFunction      = DisplacementBasedElement::displacementFunction(par, dx);}
\DoxyCodeLine{267     \textcolor{keyword}{auto} strainFunction       = DisplacementBasedElement::strainFunction(par, dx);}
\DoxyCodeLine{268     \textcolor{keyword}{const} \textcolor{keyword}{auto}\& numberOfNodes = DisplacementBasedElement::numberOfNodes();}
\DoxyCodeLine{269     \textcolor{keyword}{const} \textcolor{keyword}{auto} disp           = \mbox{\hyperlink{a00320_ga545d74839895f4576a3b8c97d72abefd}{Dune::viewAsFlatEigenVector}}(uFunction.coefficientsRef());}
\DoxyCodeLine{270 }
\DoxyCodeLine{271     \textcolor{keyword}{using namespace }Dune::DerivativeDirections;}
\DoxyCodeLine{272 }
\DoxyCodeLine{273     \textcolor{keyword}{auto} C         = DisplacementBasedElement::materialTangentFunction(par);}
\DoxyCodeLine{274     \textcolor{keyword}{const} \textcolor{keyword}{auto} geo = localView().element().geometry();}
\DoxyCodeLine{275 }
\DoxyCodeLine{276     \textcolor{comment}{// Internal forces from enhanced strains}}
\DoxyCodeLine{277     std::visit(}
\DoxyCodeLine{278         [\&]<\textcolor{keyword}{typename} EAST>(\textcolor{keyword}{const} EAST\& easFunction) \{}
\DoxyCodeLine{279           \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (not std::is\_same\_v<std::monostate, EAST>) \{}
\DoxyCodeLine{280             \textcolor{keyword}{constexpr} \textcolor{keywordtype}{int} enhancedStrainSize = EAST::enhancedStrainSize;}
\DoxyCodeLine{281             Eigen::Matrix<double, enhancedStrainSize, enhancedStrainSize> D;}
\DoxyCodeLine{282             calculateDAndLMatrix(easFunction, par, D, L);}
\DoxyCodeLine{283 }
\DoxyCodeLine{284             \textcolor{keyword}{const} \textcolor{keyword}{auto} alpha = (-\/D.inverse() * L * disp).eval();}
\DoxyCodeLine{285 }
\DoxyCodeLine{286             \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& [gpIndex, gp] : strainFunction.viewOverIntegrationPoints()) \{}
\DoxyCodeLine{287               \textcolor{keyword}{const} \textcolor{keyword}{auto} M            = easFunction.calcM(gp.position());}
\DoxyCodeLine{288               \textcolor{keyword}{const} \textcolor{keywordtype}{double} intElement = geo.integrationElement(gp.position()) * gp.weight();}
\DoxyCodeLine{289               \textcolor{keyword}{const} \textcolor{keyword}{auto} CEval        = C(gpIndex);}
\DoxyCodeLine{290               \textcolor{keyword}{auto} stresses           = (CEval * M * alpha).eval();}
\DoxyCodeLine{291               \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < numberOfNodes; ++i) \{}
\DoxyCodeLine{292                 \textcolor{keyword}{const} \textcolor{keyword}{auto} bopI = strainFunction.evaluateDerivative(gpIndex, wrt(coeff(i)), on(gridElement));}
\DoxyCodeLine{293                 force.template segment<Traits::worlddim>(Traits::worlddim * i) +=}
\DoxyCodeLine{294                     bopI.transpose() * stresses * intElement;}
\DoxyCodeLine{295               \}}
\DoxyCodeLine{296             \}}
\DoxyCodeLine{297           \}}
\DoxyCodeLine{298         \},}
\DoxyCodeLine{299         easVariant\_);}
\DoxyCodeLine{300   \}}
\DoxyCodeLine{301 }
\DoxyCodeLine{302 \textcolor{keyword}{private}:}
\DoxyCodeLine{303   \textcolor{keyword}{using }EASVariant = \mbox{\hyperlink{a01290_a167e8b0ab6cfef7abffc556e699d54c8}{EAS::Variants<Geometry>::type}};}
\DoxyCodeLine{304   EASVariant easVariant\_;}
\DoxyCodeLine{305   \textcolor{keyword}{mutable} Eigen::MatrixXd L;}
\DoxyCodeLine{306   \textcolor{keyword}{template} <\textcolor{keywordtype}{int} enhancedStrainSize>}
\DoxyCodeLine{307   \textcolor{keywordtype}{void} calculateDAndLMatrix(\textcolor{keyword}{const} \textcolor{keyword}{auto}\& easFunction, \textcolor{keyword}{const} \textcolor{keyword}{auto}\& par,}
\DoxyCodeLine{308                             Eigen::Matrix<double, enhancedStrainSize, enhancedStrainSize>\& DMat,}
\DoxyCodeLine{309                             Eigen::MatrixXd\& LMat)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{310     \textcolor{keyword}{using namespace }\mbox{\hyperlink{a00331}{Dune}};}
\DoxyCodeLine{311     \textcolor{keyword}{using namespace }Dune::DerivativeDirections;}
\DoxyCodeLine{312 }
\DoxyCodeLine{313     \textcolor{keyword}{auto} strainFunction      = DisplacementBasedElement::strainFunction(par);}
\DoxyCodeLine{314     \textcolor{keyword}{const} \textcolor{keyword}{auto} C             = DisplacementBasedElement::materialTangentFunction(par);}
\DoxyCodeLine{315     \textcolor{keyword}{const} \textcolor{keyword}{auto} geo           = localView().element().geometry();}
\DoxyCodeLine{316     \textcolor{keyword}{const} \textcolor{keyword}{auto} numberOfNodes = DisplacementBasedElement::numberOfNodes();}
\DoxyCodeLine{317     DMat.setZero();}
\DoxyCodeLine{318     LMat.setZero(enhancedStrainSize, localView().size());}
\DoxyCodeLine{319     \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& [gpIndex, gp] : strainFunction.viewOverIntegrationPoints()) \{}
\DoxyCodeLine{320       \textcolor{keyword}{const} \textcolor{keyword}{auto} M      = easFunction.calcM(gp.position());}
\DoxyCodeLine{321       \textcolor{keyword}{const} \textcolor{keyword}{auto} CEval  = C(gpIndex);}
\DoxyCodeLine{322       \textcolor{keyword}{const} \textcolor{keywordtype}{double} detJ = geo.integrationElement(gp.position());}
\DoxyCodeLine{323       DMat += M.transpose() * CEval * M * detJ * gp.weight();}
\DoxyCodeLine{324       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0U; i < numberOfNodes; ++i) \{}
\DoxyCodeLine{325         \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} I = Traits::worlddim * i;}
\DoxyCodeLine{326         \textcolor{keyword}{const} \textcolor{keyword}{auto} Bi  = strainFunction.evaluateDerivative(gpIndex, wrt(coeff(i)), on(gridElement));}
\DoxyCodeLine{327         LMat.template block<enhancedStrainSize, Traits::worlddim>(0, I) +=}
\DoxyCodeLine{328             M.transpose() * CEval * Bi * detJ * gp.weight();}
\DoxyCodeLine{329       \}}
\DoxyCodeLine{330     \}}
\DoxyCodeLine{331   \}}
\DoxyCodeLine{332 \};}
\DoxyCodeLine{333 \} \textcolor{comment}{// namespace Ikarus}}
\DoxyCodeLine{334 }
\DoxyCodeLine{335 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{336 \textcolor{preprocessor}{  \#error EnhancedAssumedStrains depends on dune-\/localfefunctions, which is not included}}
\DoxyCodeLine{337 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
