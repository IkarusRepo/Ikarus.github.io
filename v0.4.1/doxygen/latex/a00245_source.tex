\hypertarget{a00245_source}{}\doxysection{autodifffe.\+hh}
\label{a00245_source}\index{autodifffe.hh@{autodifffe.hh}}
\mbox{\hyperlink{a00245}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// SPDX-\/FileCopyrightText: 2021-\/2024 The Ikarus Developers mueller@ibb.uni-\/stuttgart.de}}
\DoxyCodeLine{2 \textcolor{comment}{// SPDX-\/License-\/Identifier: LGPL-\/3.0-\/or-\/later}}
\DoxyCodeLine{3 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <autodiff/forward/dual/dual.hpp>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <autodiff/forward/dual/eigen.hpp>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00257}{ikarus/finiteelements/ferequirements.hh}}>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00260}{ikarus/finiteelements/fetraits.hh}}>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{a00020}{ikarus/utils/traits.hh}}>}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{keyword}{namespace }\mbox{\hyperlink{a00325}{Ikarus}} \{}
\DoxyCodeLine{19 }
\DoxyCodeLine{29 \textcolor{keyword}{template} <\textcolor{keyword}{typename} FEImpl, \textcolor{keyword}{typename} FER = FERequirements<>, \textcolor{keywordtype}{bool} useEigenRef = false, \textcolor{keywordtype}{bool} forceAutoDiff = false>}
\DoxyCodeLine{30 \textcolor{keyword}{class }\mbox{\hyperlink{a01222}{AutoDiffFE}} : \textcolor{keyword}{public} FEImpl}
\DoxyCodeLine{31 \{}
\DoxyCodeLine{32 \textcolor{keyword}{public}:}
\DoxyCodeLine{33   \textcolor{keyword}{using }\mbox{\hyperlink{a01222_a55e79f1fd8fa7a9554efd396aa69d03d}{RealFE}}            = FEImpl;                             }
\DoxyCodeLine{34   \textcolor{keyword}{using }\mbox{\hyperlink{a01222_a781385c5016ede8dec178f57e900263c}{Basis}}             = \textcolor{keyword}{typename} RealFE::Basis;             }
\DoxyCodeLine{35   \textcolor{keyword}{using }\mbox{\hyperlink{a01258}{Traits}}            = \mbox{\hyperlink{a01258}{FETraits<Basis, FER, useEigenRef>}};  }
\DoxyCodeLine{36   \textcolor{keyword}{using }\mbox{\hyperlink{a01222_a0b46f142dac2d62833c3198845b39c2d}{LocalView}}         = \textcolor{keyword}{typename} \mbox{\hyperlink{a01258_ab45140c593175ec84e44e41c8681da90}{Traits::LocalView}};         }
\DoxyCodeLine{37   \textcolor{keyword}{using }\mbox{\hyperlink{a01222_a2e94f1607fc0a1b2be051002a5edbb0c}{Element}}           = \textcolor{keyword}{typename} \mbox{\hyperlink{a01258_a66ef325fde5f1608478498ae6581e33b}{Traits::Element}};           }
\DoxyCodeLine{38   \textcolor{keyword}{using }\mbox{\hyperlink{a01222_a757f3808eea2fa9d03e21ebb1454e8b3}{FERequirementType}} = \textcolor{keyword}{typename} \mbox{\hyperlink{a01258_af25ce4c31d34d582828b36c3ab80208f}{Traits::FERequirementType}}; }
\DoxyCodeLine{39 }
\DoxyCodeLine{46   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01222_aed0fc753f44d568f4be4861aa62f2159}{calculateMatrix}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01222_a757f3808eea2fa9d03e21ebb1454e8b3}{FERequirementType}}\& req, \textcolor{keyword}{typename} Traits::template MatrixType<> h)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{47     \textcolor{comment}{// real element implements calculateMatrix by itself, then we simply forward the call}}
\DoxyCodeLine{48     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ RealFE::calculateMatrix(req, h); \} and not forceAutoDiff) \{}
\DoxyCodeLine{49       RealFE::calculateMatrix(req, h);}
\DoxyCodeLine{50     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{51                            this-\/>\textcolor{keyword}{template} calculateVectorImpl<autodiff::dual>(}
\DoxyCodeLine{52                                req, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<autodiff::dual>>(),}
\DoxyCodeLine{53                                std::declval<const Eigen::VectorXdual\&>());}
\DoxyCodeLine{54                          \}) \{}
\DoxyCodeLine{55       \textcolor{comment}{// real element implements calculateVector by itself, therefore we only need first order derivatives}}
\DoxyCodeLine{56       Eigen::VectorXdual dx(this-\/>localView().size());}
\DoxyCodeLine{57       Eigen::VectorXdual g(this-\/>localView().size());}
\DoxyCodeLine{58       dx.setZero();}
\DoxyCodeLine{59       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) -\/> \textcolor{keyword}{auto}\& \{}
\DoxyCodeLine{60         g.setZero();}
\DoxyCodeLine{61         this-\/>\textcolor{keyword}{template} calculateVectorImpl<autodiff::dual>(req, g, x);}
\DoxyCodeLine{62         \textcolor{keywordflow}{return} g;}
\DoxyCodeLine{63       \};}
\DoxyCodeLine{64       jacobian(f, autodiff::wrt(dx), at(dx), g, h);}
\DoxyCodeLine{65     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{66                            this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual2nd>(}
\DoxyCodeLine{67                                req, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<autodiff::dual2nd>>());}
\DoxyCodeLine{68                          \}) \{}
\DoxyCodeLine{69       \textcolor{comment}{// real element implements calculateScalar by itself, therefore we need second order derivatives}}
\DoxyCodeLine{70       Eigen::VectorXdual2nd dx(this-\/>localView().size());}
\DoxyCodeLine{71       Eigen::VectorXd g;}
\DoxyCodeLine{72       autodiff::dual2nd e;}
\DoxyCodeLine{73       dx.setZero();}
\DoxyCodeLine{74       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual2nd>(req, x); \};}
\DoxyCodeLine{75       hessian(f, autodiff::wrt(dx), at(dx), e, g, h);}
\DoxyCodeLine{76     \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{77       \textcolor{keyword}{static\_assert}(Dune::AlwaysFalse<AutoDiffFE>::value,}
\DoxyCodeLine{78                     \textcolor{stringliteral}{"{}Appropriate calculateScalarImpl or calculateVectorImpl functions are not implemented for the "{}}}
\DoxyCodeLine{79                     \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{80   \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{88   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01222_aa677eba3f26376fedbf5b45c12dc0e77}{calculateVector}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01222_a757f3808eea2fa9d03e21ebb1454e8b3}{FERequirementType}}\& req, \textcolor{keyword}{typename} Traits::template VectorType<> g)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{89     \textcolor{comment}{// real element implements calculateVector by itself, then we simply forward the call}}
\DoxyCodeLine{90     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{91                     this-\/>\textcolor{keyword}{template} calculateVectorImpl<double>(}
\DoxyCodeLine{92                         req, std::declval<\textcolor{keyword}{typename} Traits::template VectorType<double>>(),}
\DoxyCodeLine{93                         std::declval<const Eigen::VectorXd\&>());}
\DoxyCodeLine{94                   \} and not forceAutoDiff) \{}
\DoxyCodeLine{95       \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateVectorImpl<double>(req, g);}
\DoxyCodeLine{96     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{}
\DoxyCodeLine{97                            this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual>(}
\DoxyCodeLine{98                                req, std::declval<const Eigen::VectorXdual\&>());}
\DoxyCodeLine{99                          \}) \{}
\DoxyCodeLine{100       \textcolor{comment}{// real element implements calculateScalar by itself, therefore we need first order derivatives}}
\DoxyCodeLine{101       Eigen::VectorXdual dx(this-\/>localView().size());}
\DoxyCodeLine{102       dx.setZero();}
\DoxyCodeLine{103       autodiff::dual e;}
\DoxyCodeLine{104       \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>\textcolor{keyword}{template} calculateScalarImpl<autodiff::dual>(req, x); \};}
\DoxyCodeLine{105       gradient(f, autodiff::wrt(dx), at(dx), e, g);}
\DoxyCodeLine{106     \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{107       \textcolor{keyword}{static\_assert}(Dune::AlwaysFalse<AutoDiffFE>::value,}
\DoxyCodeLine{108                     \textcolor{stringliteral}{"{}Appropriate calculateScalarImpl function is not implemented for the "{}}}
\DoxyCodeLine{109                     \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{110   \}}
\DoxyCodeLine{111 }
\DoxyCodeLine{119   \textcolor{keywordtype}{void} \mbox{\hyperlink{a01222_ac4a83219a78d90224f288ff2fe339da2}{calculateLocalSystem}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01222_a757f3808eea2fa9d03e21ebb1454e8b3}{FERequirementType}}\& req, \textcolor{keyword}{typename} Traits::template MatrixType<> h,}
\DoxyCodeLine{120                             \textcolor{keyword}{typename} Traits::template VectorType<> g)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{121     Eigen::VectorXdual2nd dx(this-\/>localView().size());}
\DoxyCodeLine{122     dx.setZero();}
\DoxyCodeLine{123     \textcolor{keyword}{auto} f = [\&](\textcolor{keyword}{auto}\& x) \{ \textcolor{keywordflow}{return} this-\/>calculateScalarImpl(req, x); \};}
\DoxyCodeLine{124     hessian(f, autodiff::wrt(dx), at(dx), g, h);}
\DoxyCodeLine{125   \}}
\DoxyCodeLine{126 }
\DoxyCodeLine{133   [[nodiscard]] \textcolor{keywordtype}{double} \mbox{\hyperlink{a01222_a467c4ed0b15360441cc5d77b6eb5c591}{calculateScalar}}(\textcolor{keyword}{const} \mbox{\hyperlink{a01222_a757f3808eea2fa9d03e21ebb1454e8b3}{FERequirementType}}\& par)\textcolor{keyword}{ const }\{}
\DoxyCodeLine{134     \textcolor{comment}{// real element implements calculateScalar by itself, then we simply forward the call}}
\DoxyCodeLine{135     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ RealFE::calculateScalar(par); \}) \{}
\DoxyCodeLine{136       \textcolor{keywordflow}{return} RealFE::calculateScalar(par);}
\DoxyCodeLine{137     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (\textcolor{keyword}{requires} \{ this-\/>calculateScalarImpl(par); \}) \{}
\DoxyCodeLine{138       \textcolor{comment}{// real element only implements the protected calculateScalarImpl by itself, thus we call that one.}}
\DoxyCodeLine{139       \textcolor{keywordflow}{return} this-\/>calculateScalarImpl(par);}
\DoxyCodeLine{140     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{141       \textcolor{keyword}{static\_assert}(Dune::AlwaysFalse<AutoDiffFE>::value,}
\DoxyCodeLine{142                     \textcolor{stringliteral}{"{}Appropriate calculateScalar and calculateScalarImpl functions are not implemented for the "{}}}
\DoxyCodeLine{143                     \textcolor{stringliteral}{"{}chosen element."{}});}
\DoxyCodeLine{144     \}}
\DoxyCodeLine{145   \}}
\DoxyCodeLine{146 }
\DoxyCodeLine{152   \textcolor{keyword}{const} \mbox{\hyperlink{a01222_a55e79f1fd8fa7a9554efd396aa69d03d}{RealFE}}\& \mbox{\hyperlink{a01222_ae5b38b906dbe5945d9e1928a7db49fe4}{realFE}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} *\textcolor{keyword}{this}; \}}
\DoxyCodeLine{153 }
\DoxyCodeLine{161   \textcolor{keyword}{template} <\textcolor{keyword}{typename}... Args>}
\DoxyCodeLine{162   \textcolor{keyword}{explicit} \mbox{\hyperlink{a01222_a50e737961fa37b8401f57c6f919f0091}{AutoDiffFE}}(Args\&\&... args)}
\DoxyCodeLine{163       : \mbox{\hyperlink{a01222_a55e79f1fd8fa7a9554efd396aa69d03d}{RealFE}}\{std::forward<Args>(args)...\} \{\}}
\DoxyCodeLine{164 \};}
\DoxyCodeLine{165 \} \textcolor{comment}{// namespace Ikarus}}

\end{DoxyCode}
